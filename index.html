<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ÊâãÊêñÈ£≤Â§ßÁéã - Âú®Ê∞∏ÂêâË∑Ø30Â∑∑ÈñãÂâµ‰Ω†ÁöÑÈ£≤ÊñôÂ∏ùÂúãÔºÅ">
    <title>üßã ÊâãÊêñÈ£≤Â§ßÁéã</title>
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d1f14">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÊâãÊêñÈ£≤Â§ßÁéã">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4TPNDC87W6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4TPNDC87W6');
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Silkscreen:wght@400;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dirt: '#866043',
                        dirtLight: '#a07855',
                        dirtDark: '#5c4230',
                        stone: '#7a7a7a',
                        stoneLight: '#9a9a9a',
                        stoneDark: '#5a5a5a',
                        grass: '#5d823e',
                        grassLight: '#7da05e',
                        grassDark: '#3d622e',
                        gold: '#e3b526',
                        goldLight: '#f5d456',
                        goldDark: '#b38916',
                    },
                    fontFamily: {
                        pixel: ['VT323', 'monospace'],
                        silkscreen: ['Silkscreen', 'monospace'],
                    },
                    boxShadow: {
                        pixel: '4px 4px 0px 0px rgba(0,0,0,0.8)',
                        pixelInset: 'inset 2px 2px 0px 0px rgba(255,255,255,0.2), inset -2px -2px 0px 0px rgba(0,0,0,0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: pan-x pan-y;
            background: #000;
        }

        /* ÊâãÊ©üÁõ¥ÂºèÊØî‰æãÂÆπÂô® */
        #root {
            max-width: 480px;
            width: 100%;
            height: 100%;
            max-height: 100vh;
            aspect-ratio: 9 / 16;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            background: #2d1f14;
        }

        /* Ëû¢ÂπïÂ§™ÂØ¨ÊôÇÔºåÈôêÂà∂È´òÂ∫¶‰∏¶ÂûÇÁõ¥ÁΩÆ‰∏≠ */
        @media (min-aspect-ratio: 9/16) {
            #root {
                height: 100vh;
                width: auto;
            }
        }

        body {
            background: #2d1f14;
            font-family: 'VT323', monospace;
        }

        /* Pixel-perfect rendering */
        img,
        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Custom scrollbar - hidden */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Pixel button press effect */
        .pixel-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.8) !important;
        }

        /* Scene transition */
        .scene-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Floating animation for decorations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* Blinking cursor for text */
        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // ==================== CONSTANTS ====================
        const GAME_TIME = {
            REAL_HOURS_PER_GAME_DAY: 2,  // 2 real hours = 1 game day
            BUSINESS_OPEN_HOUR: 11,      // 11 AM
            BUSINESS_CLOSE_HOUR: 19,     // 7 PM
        };

        const INGREDIENTS = {
            bases: [
                { id: 'black-tea', name: 'Á¥ÖËå∂', cost: 5, attraction: 10, emoji: 'üçµ', trait: '‰∏äÁè≠ÊóèÁÜ±ÊÑõ' },
                { id: 'green-tea', name: 'Á∂†Ëå∂', cost: 5, attraction: 10, emoji: 'üçÉ', trait: 'Ê∏ÖÁàΩËß£ËÜ©' },
                { id: 'oolong', name: 'ÁÉèÈæçËå∂', cost: 7, attraction: 12, emoji: 'ü´ñ', trait: 'È´òÂà©ÊΩ§ÂìÅÈ†Ö' },
                { id: 'winter-melon', name: 'ÂÜ¨ÁìúËå∂', cost: 6, attraction: 8, emoji: 'üßä', trait: 'Â≠∏ÁîüÊóèÈ¶ñÈÅ∏' },
            ],
            toppings: [
                { id: 'boba', name: 'ÁèçÁè†', cost: 5, attraction: 20, emoji: '‚ö´', trait: 'Á∂ìÂÖ∏ÂøÖÂÇô' },
                { id: 'pudding', name: 'Â∏É‰∏Å', cost: 8, attraction: 15, emoji: 'üçÆ', trait: 'Â∞èÂ≠©ÊúÄÊÑõ' },
                { id: 'coconut-jelly', name: 'Ê§∞Êûú', cost: 6, attraction: 12, emoji: 'ü••', trait: 'Âè£ÊÑüÁàΩËÑÜ' },
                { id: 'grass-jelly', name: '‰ªôËçâ', cost: 5, attraction: 10, emoji: 'üåø', trait: 'Ê∂àÊöëËÅñÂìÅ' },
                { id: 'taro', name: 'ËäãÊ≥•', cost: 12, attraction: 25, emoji: 'üç†', trait: 'ËäãÈ†≠ÊéßÁòãÁãÇ' },
                { id: 'fun-guo', name: 'Á≤âÁ≤ø', cost: 5, attraction: 15, emoji: 'üü®', trait: 'Âè§Êó©Âë≥' },
                { id: 'noodles', name: 'Á≤âÊ¢ù', cost: 5, attraction: 10, emoji: 'ü•¢', trait: 'È£ΩË∂≥ÊÑü' },
                { id: 'aiyu', name: 'ÊÑõÁéâ', cost: 8, attraction: 12, emoji: 'üçã', trait: 'Ê∏ÖÊ∂ºÈÄÄÁÅ´' },
                { id: 'white-pearl', name: 'ÂØíÂ§©', cost: 10, attraction: 18, emoji: '‚ö™', trait: '‰ΩéÂç°ÂÅ•Â∫∑' },
                { id: 'aloe', name: 'ËòÜËñà', cost: 9, attraction: 15, emoji: 'üåµ', trait: 'È§äÈ°èÁæéÂÆπ' },
                { id: 'milk-foam', name: 'Â•∂Ëìã', cost: 15, attraction: 30, emoji: '‚òÅÔ∏è', trait: 'Á∂≤Á¥ÖÊâìÂç°' },
            ],
        };

        const AI_COMPETITORS = [
            { id: 1, name: 'Âº∑Â∞ºÁ¥ÖËå∂ÂÖ¨Á§æ', monthlyRevenue: 850000, tier: 'ÂÇ≥Â•á', color: '#ff6b6b' },
            { id: 2, name: '60Âµê', monthlyRevenue: 620000, tier: 'Âõ∞Èõ£', color: '#ffa502' },
            { id: 3, name: 'Â§ßÂêçÊú¨‰Ωç', monthlyRevenue: 480000, tier: 'ÊôÆÈÄö', color: '#2ed573' },
            { id: 4, name: 'OGÊô∫ÊÖßË£ΩËå∂', monthlyRevenue: 350000, tier: 'Á©©ÂÅ•', color: '#1e90ff' },
            { id: 5, name: 'Ê≤íÈ£≤ Noin', monthlyRevenue: 220000, tier: 'Êñ∞Êâã', color: '#a4b0be' },
        ];



        // ==================== UTILITY FUNCTIONS ====================
        const formatMoney = (amount) => {
            return `NT$${Math.round(amount || 0).toLocaleString()}`;
        };

        // Game Time Functions
        const getGameTime = (gameStartTime) => {
            const realElapsedMs = Date.now() - gameStartTime;
            const realElapsedHours = realElapsedMs / (1000 * 60 * 60);
            const gameElapsedHours = realElapsedHours * (24 / GAME_TIME.REAL_HOURS_PER_GAME_DAY);
            const gameHour = gameElapsedHours % 24;
            const gameDay = Math.floor(gameElapsedHours / 24) + 1;
            return { gameHour, gameDay };
        };

        const isBusinessOpen = (gameHour, is24h) => {
            if (is24h) return true;
            return gameHour >= GAME_TIME.BUSINESS_OPEN_HOUR && gameHour < GAME_TIME.BUSINESS_CLOSE_HOUR;
        };

        const formatGameTime = (gameHour) => {
            const hours = Math.floor(gameHour);
            const minutes = Math.floor((gameHour % 1) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        };

        const calculateDrinkCost = (drink) => {
            const base = INGREDIENTS.bases.find(b => b.id === drink.base);
            const toppingsCost = drink.toppings.reduce((sum, t) => {
                const topping = INGREDIENTS.toppings.find(tp => tp.id === t);
                return sum + (topping?.cost || 0);
            }, 0);
            return (base?.cost || 0) + toppingsCost;
        };

        const calculateAttraction = (drink) => {
            const base = INGREDIENTS.bases.find(b => b.id === drink.base);
            const toppingsAttraction = drink.toppings.reduce((sum, t) => {
                const topping = INGREDIENTS.toppings.find(tp => tp.id === t);
                return sum + (topping?.attraction || 0);
            }, 0);
            return (base?.attraction || 0) + toppingsAttraction;
        };

        // ==================== PIXEL COMPONENTS ====================
        const PixelButton = ({ children, onClick, variant = 'primary', size = 'md', disabled = false, className = '' }) => {
            const variants = {
                primary: 'bg-grass hover:bg-grassLight border-grassDark',
                secondary: 'bg-dirt hover:bg-dirtLight border-dirtDark',
                gold: 'bg-gold hover:bg-goldLight border-goldDark text-dirtDark',
                danger: 'bg-red-600 hover:bg-red-500 border-red-800',
            };
            const sizes = {
                sm: 'px-3 py-1 text-lg',
                md: 'px-5 py-2 text-xl',
                lg: 'px-8 py-3 text-2xl',
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    className={`
                        pixel-btn font-pixel text-white
                        border-4 border-b-8 shadow-pixel
                        transition-colors duration-100
                        ${variants[variant]}
                        ${sizes[size]}
                        ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
                        ${className}
                    `}
                >
                    {children}
                </button>
            );
        };

        const PixelPanel = ({ children, className = '', variant = 'dirt' }) => {
            const variants = {
                dirt: 'bg-dirt border-dirtDark',
                stone: 'bg-stone border-stoneDark',
                dark: 'bg-dirtDark border-black',
            };

            return (
                <div className={`
                    border-4 shadow-pixel shadow-pixelInset
                    ${variants[variant]}
                    ${className}
                `}>
                    {children}
                </div>
            );
        };

        const PixelTab = ({ tabs, activeTab, onTabChange }) => {
            return (
                <div className="flex gap-1">
                    {tabs.map((tab) => (
                        <button
                            key={tab.id}
                            onClick={() => onTabChange(tab.id)}
                            className={`
                                pixel-btn font-pixel text-lg px-4 py-2
                                border-4 border-b-0 transition-colors
                                ${activeTab === tab.id
                                    ? 'bg-dirt border-dirtDark text-white -mb-1 z-10'
                                    : 'bg-stone border-stoneDark text-gray-300 hover:bg-stoneLight'}
                            `}
                        >
                            {tab.icon} {tab.label}
                        </button>
                    ))}
                </div>
            );
        };

        // ==================== HUD COMPONENT ====================
        const GameHUD = ({ gameState, onMenuClick }) => {
            const [currentTime, setCurrentTime] = useState(() => getGameTime(gameState.gameStartTime));

            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTime(getGameTime(gameState.gameStartTime));
                }, 1000); // Update every second
                return () => clearInterval(interval);
            }, [gameState.gameStartTime]);

            const businessOpen = isBusinessOpen(currentTime.gameHour, gameState.is24h);

            return (
                <div className="absolute top-0 left-0 right-0 z-50 p-2">
                    <PixelPanel className="p-2" variant="dark">
                        <div className="flex items-center justify-between gap-2">
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-1">
                                    <span className="text-xl">üí∞</span>
                                    <span className="font-pixel text-gold text-lg">
                                        {formatMoney(gameState.money)}
                                    </span>
                                </div>
                                <div className="flex items-center gap-1">
                                    <span className="text-xl">üïê</span>
                                    <span className={`font-pixel text-lg ${businessOpen ? 'text-grassLight' : 'text-red-400'}`}>
                                        {formatGameTime(currentTime.gameHour)}
                                    </span>
                                </div>
                                <div className="flex items-center gap-1">
                                    <span className="text-xl">üìÖ</span>
                                    <span className="font-pixel text-white text-lg">
                                        Day {currentTime.gameDay}
                                    </span>
                                </div>
                            </div>
                            <PixelButton size="sm" variant="secondary" onClick={onMenuClick}>
                                ‚ò∞
                            </PixelButton>
                        </div>
                    </PixelPanel>
                </div>
            );
        };

        // ==================== NAVIGATION BAR ====================
        const NavigationBar = ({ currentScene, onSceneChange }) => {
            const scenes = [
                { id: 'street', label: 'Ë°óÈÅì', icon: 'üèòÔ∏è' },
                { id: 'store', label: 'Â∫óÈù¢', icon: 'üè™' },
                { id: 'manage', label: 'ÁÆ°ÁêÜ', icon: 'üìä' },
            ];

            return (
                <div className="absolute bottom-0 left-0 right-0 z-50 p-2">
                    <PixelPanel className="p-1" variant="dark">
                        <div className="flex justify-around">
                            {scenes.map((scene) => (
                                <button
                                    key={scene.id}
                                    onClick={() => onSceneChange(scene.id)}
                                    className={`
                                        pixel-btn flex-1 mx-1 py-3 font-pixel text-lg
                                        border-4 transition-all duration-100
                                        ${currentScene === scene.id
                                            ? 'bg-grass border-grassDark text-white shadow-pixel'
                                            : 'bg-stone border-stoneDark text-gray-300 hover:bg-stoneLight'}
                                    `}
                                >
                                    <div className="text-2xl">{scene.icon}</div>
                                    <div>{scene.label}</div>
                                </button>
                            ))}
                        </div>
                    </PixelPanel>
                </div>
            );
        };

        // ==================== ASSET HELPERS ====================
        const drawPixelSprite = (ctx, x, y, scale, type, frame = 0, facing = 'front', heldItem = null) => {
            // Simple Minecraft-style proportions
            const p = scale; // 1 pixel unit

            // Palettes
            const PALETTES = {
                student: { skin: '#ffeaa7', hair: '#2d3436', shirt: '#fff', pants: '#0984e3' },
                worker: { skin: '#ffeaa7', hair: '#636e72', shirt: '#81ecec', pants: '#2d3436' },
                hipster: { skin: '#fab1a0', hair: '#d63031', shirt: '#fdcb6e', pants: '#6c5ce7' },
                tourist: { skin: '#74b9ff', hair: '#ffeaa7', shirt: '#ff7675', pants: '#55efc4' }
            };
            const colors = PALETTES[type] || PALETTES.student;

            // Bobbing animation
            const bob = Math.sin(frame * 0.2) * 2;
            const legAngle = Math.sin(frame * 0.2) * 20;
            const armAngle = Math.cos(frame * 0.2) * 20;

            ctx.save();
            ctx.translate(x, y + bob);

            if (facing !== 'front') {
                const dir = facing === 'left' ? -1 : 1;
                ctx.scale(dir, 1);

                // Head
                ctx.fillStyle = colors.skin;
                ctx.fillRect(-3 * p, -18 * p, 6 * p, 8 * p);
                ctx.fillStyle = colors.hair;
                ctx.fillRect(-4 * p, -18 * p, 4 * p, 8 * p);
                ctx.fillRect(-3 * p, -19 * p, 6 * p, 2 * p);

                // Body
                ctx.fillStyle = colors.shirt;
                ctx.fillRect(-2 * p, -10 * p, 4 * p, 8 * p);

                // Arms
                ctx.fillStyle = colors.skin;
                ctx.save(); ctx.translate(0, -9 * p);
                ctx.rotate(armAngle * Math.PI / 180);
                ctx.fillRect(-1 * p, 0, 2 * p, 7 * p);

                // Held Item (Side View)
                if (heldItem === 'drink') {
                    ctx.fillStyle = '#fab1a0'; // Cup
                    ctx.fillRect(-1 * p, 5 * p, 3 * p, 4 * p);
                    ctx.fillStyle = '#fff'; // Lid
                    ctx.fillRect(-1 * p, 4 * p, 3 * p, 1 * p);
                }

                ctx.restore();

                // Legs
                ctx.fillStyle = colors.pants;
                ctx.save(); ctx.translate(0, -2 * p);
                ctx.rotate(legAngle * Math.PI / 180);
                ctx.fillRect(-2 * p, 0, 4 * p, 8 * p); ctx.restore();
                ctx.save(); ctx.translate(0, -2 * p);
                ctx.rotate(-legAngle * Math.PI / 180);
                ctx.fillRect(-2 * p, 0, 4 * p, 8 * p); ctx.restore();

                ctx.restore();
                return;
            }

            // Head (8x8)
            ctx.fillStyle = colors.skin;
            ctx.fillRect(-4 * p, -18 * p, 8 * p, 8 * p);
            // Hair
            ctx.fillStyle = colors.hair;
            ctx.fillRect(-4 * p, -18 * p, 8 * p, 2 * p); // Top
            ctx.fillRect(-4 * p, -18 * p, 2 * p, 6 * p); // Side L
            ctx.fillRect(2 * p, -18 * p, 2 * p, 6 * p); // Side R

            // Body (8x8)
            ctx.fillStyle = colors.shirt;
            ctx.fillRect(-4 * p, -10 * p, 8 * p, 8 * p);

            // Arms
            ctx.fillStyle = colors.skin;
            ctx.fillRect(-6 * p, -10 * p, 2 * p, 8 * p); // L
            ctx.fillRect(4 * p, -10 * p, 2 * p, 8 * p); // R

            // Legs (Independent animation)
            ctx.fillStyle = colors.pants;
            // Leg L
            ctx.save();
            ctx.translate(-2 * p, -2 * p);
            ctx.rotate(legAngle * Math.PI / 180);
            ctx.fillRect(-2 * p, 0, 4 * p, 8 * p);
            ctx.restore();
            // Leg R
            ctx.save();
            ctx.translate(2 * p, -2 * p);
            ctx.rotate(-legAngle * Math.PI / 180);
            ctx.fillRect(-2 * p, 0, 4 * p, 8 * p);
            ctx.restore();

            ctx.restore();
        };

        const drawShopStorefront = (ctx, x, y, width, height, type, name, color) => {
            // Main Building Block
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, height);

            // Roof / Awning
            ctx.fillStyle = '#fff';
            for (let i = 0; i < width; i += 20) {
                ctx.fillStyle = (i / 20) % 2 === 0 ? color : '#fff';
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i + 20, y);
                ctx.lineTo(x + i + 10, y + 20);
                ctx.fill();
            }

            // Signboard
            ctx.fillStyle = '#2d3436';
            ctx.fillRect(x + 10, y + 30, width - 20, 30);
            ctx.fillStyle = '#fab1a0'; // Neon-ish
            ctx.font = '16px "Silkscreen"';
            ctx.textAlign = 'center';
            ctx.fillText(name, x + width / 2, y + 52);

            // Door / Window
            ctx.fillStyle = '#b2bec3'; // Glass
            ctx.fillRect(x + 20, y + 70, width - 40, height - 70);

            // Frame
            ctx.strokeStyle = '#636e72';
            ctx.lineWidth = 4;
            ctx.strokeRect(x + 20, y + 70, width - 40, height - 70);
        };

        // ==================== MARKET RESEARCH MODAL ====================
        const CompetitorModal = ({ shop, onClose }) => {
            const menu = useMemo(() => {
                // Generate random menu for competitor
                return Array.from({ length: 5 }).map((_, i) => ({
                    name: ['ÊãõÁâå', 'ÁâπË™ø', 'ÊãøÈêµ', 'ÈÆÆÂ•∂', 'ÂÜ∞Ëå∂'][i] + 'Ëå∂',
                    price: Math.floor(Math.random() * 30) + 30 + (shop.tier === 'ÂÇ≥Â•á' ? 20 : 0)
                }));
            }, [shop]);

            return (
                <div className="absolute inset-0 bg-black/80 z-[60] flex items-center justify-center p-6" onClick={onClose}>
                    <PixelPanel className="w-full max-w-sm p-4" variant="dirt" onClick={e => e.stopPropagation()}>
                        <h2 className="font-silkscreen text-white text-xl mb-2 text-center" style={{ color: shop.color }}>
                            {shop.name}
                        </h2>
                        <div className="text-center font-pixel text-stone mb-4">{shop.tier} Â∞çÊâã</div>

                        <div className="bg-dirtDark p-3 border-2 border-stoneDark space-y-2">
                            <h3 className="font-pixel text-gold mb-2 border-b border-stoneDark pb-1">Â∏ÇÂ†¥Ë™øÊü• (Menu)</h3>
                            {menu.map((m, i) => (
                                <div key={i} className="flex justify-between font-pixel text-white">
                                    <span>{m.name}</span>
                                    <span>${m.price}</span>
                                </div>
                            ))}
                        </div>
                        <p className="font-pixel text-stoneLight text-xs mt-3 text-center">
                            * Áü•Â∑±Áü•ÂΩºÔºåÁôæÊà∞ÁôæÂãù *
                        </p>
                        <PixelButton variant="secondary" className="w-full mt-4" onClick={onClose}>
                            ÈóúÈñâ
                        </PixelButton>
                    </PixelPanel>
                </div>
            );
        };

        // ==================== STREET SCENE (Side View) ====================
        const StreetScene = ({ gameState }) => {
            const canvasRef = useRef(null);
            const [selectedShop, setSelectedShop] = useState(null);

            // Scrolling State
            const scrollX = useRef(0);
            const isDragging = useRef(false);
            const lastX = useRef(0);

            // Initial Shops Setup
            const shops = useMemo(() => {
                const list = [
                    { id: 'player', name: gameState.shopName, color: '#e17055', isPlayer: true },
                    ...gameState.competitors.map(c => ({
                        id: c.id,
                        name: c.name,
                        color: c.color || '#a29bfe',
                        isPlayer: false,
                        tier: c.tier
                    }))
                ];
                return list;
            }, [gameState.competitors, gameState.shopName]);

            // Pedestrians
            const pedestrians = useRef(Array.from({ length: 20 }).map(() => ({
                x: Math.random() * 800,
                type: ['student', 'worker', 'hipster', 'tourist'][Math.floor(Math.random() * 4)],
                speed: (Math.random() * 0.5 + 0.2) * (Math.random() > 0.5 ? 1 : -1),
                frame: Math.random() * 100,
                depth: Math.random() // 0 (far) to 1 (close)
            }))).current;

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let animationFrameId;

                const resizeCanvas = () => {
                    const parent = canvas.parentElement;
                    if (parent) {
                        canvas.width = parent.clientWidth;
                        canvas.height = parent.clientHeight;
                    }
                };
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                // Input Handlers
                const onDown = (e) => {
                    isDragging.current = true;
                    lastX.current = e.touches ? e.touches[0].clientX : e.clientX;
                };
                const onMove = (e) => {
                    if (!isDragging.current) return;
                    e.preventDefault();
                    const cx = e.touches ? e.touches[0].clientX : e.clientX;
                    const dx = cx - lastX.current;
                    scrollX.current += dx;
                    lastX.current = cx;

                    // Constrained Boundaries based on content
                    const shopWidth = 140;
                    const gap = 20;
                    const totalContentWidth = 100 + (shops.length * shopWidth) + ((shops.length - 1) * gap);
                    const maxScroll = 0;
                    const minScroll = Math.min(0, canvas.width - totalContentWidth - 100); // 100px buffer for right side
                    if (scrollX.current > maxScroll) scrollX.current = maxScroll;
                    if (scrollX.current < minScroll) scrollX.current = minScroll;
                };
                const onUp = (e) => {
                    if (!isDragging.current) return; // Not dragging
                    isDragging.current = false;

                    // Click Detection (if moved very little)
                    // Simplified: React onClick handles click, this handles drag
                    // We can use native click vs drag distinction logic or just assume click if delta small.
                    // Let's use React onClick on the canvas wrapper for clicks separately?
                    // Actually, canvas handles all events. 
                    // Let's checks click in global listener or reuse React's onClick
                };

                // Click detection needs coordinates mapped to scroll
                const onClick = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const cx = e.clientX - rect.left;
                    const cy = e.clientY - rect.top;

                    // Check shops
                    let startX = 50 + scrollX.current;
                    const shopY = canvas.height - 450; // Match new render layout
                    const shopH = 150;
                    const shopWidth = 140;
                    const gap = 20;

                    shops.forEach(shop => {
                        if (cx >= startX && cx <= startX + shopWidth &&
                            cy >= shopY && cy <= shopY + shopH) {
                            if (!shop.isPlayer) {
                                setSelectedShop(shop);
                            }
                        }
                        startX += shopWidth + gap;
                    });
                };

                canvas.addEventListener('mousedown', onDown);
                canvas.addEventListener('touchstart', onDown);
                window.addEventListener('mousemove', onMove);
                window.addEventListener('touchmove', onMove, { passive: false });
                window.addEventListener('mouseup', onUp);
                window.addEventListener('touchend', onUp);
                canvas.addEventListener('click', onClick);

                const render = () => {
                    const width = canvas.width;
                    const height = canvas.height;
                    const sx = scrollX.current;

                    // 1. Sky (Layer 0 - Static)
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(0, 0, width, height);

                    // 2. Far Background (Layer 1 - 0.05x scroll)
                    // Sun & Glow
                    const sunX = width * 0.8 + (sx * 0.05);
                    const sunY = 100;
                    ctx.fillStyle = '#f9ca24';
                    ctx.beginPath(); ctx.arc(sunX, sunY, 40, 0, Math.PI * 2); ctx.fill();
                    const glow = ctx.createRadialGradient(sunX, sunY, 40, sunX, sunY, 80);
                    glow.addColorStop(0, 'rgba(249, 202, 36, 0.3)');
                    glow.addColorStop(1, 'rgba(249, 202, 36, 0)');
                    ctx.fillStyle = glow; ctx.fillRect(sunX - 100, sunY - 100, 200, 200);

                    // 3. Clouds (Layer 2 - 0.1x scroll)
                    const cloudScroll = sx * 0.1;
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const drawCloud = (cx, cy, scale) => {
                        ctx.beginPath();
                        ctx.arc(cx, cy, 20 * scale, 0, Math.PI * 2);
                        ctx.moveTo(cx + 40 * scale, cy - 10 * scale); // Position pen for next circle
                        ctx.arc(cx + 25 * scale, cy - 10 * scale, 15 * scale, 0, Math.PI * 2);
                        ctx.moveTo(cx + 40 * scale, cy + 10 * scale);
                        ctx.arc(cx + 25 * scale, cy + 10 * scale, 15 * scale, 0, Math.PI * 2);
                        ctx.moveTo(cx + 70 * scale, cy);
                        ctx.arc(cx + 50 * scale, cy, 20 * scale, 0, Math.PI * 2);
                        ctx.fill();
                    };
                    drawCloud(100 + cloudScroll, 150, 1.5);
                    drawCloud(500 + cloudScroll, 80, 1.2);
                    drawCloud(1000 + cloudScroll, 180, 1.0);
                    drawCloud(1400 + cloudScroll, 100, 1.3);

                    // 4. Cityscape (Layer 3 - 0.2x scroll)
                    const cityScroll = sx * 0.2;
                    ctx.fillStyle = '#b2bec3';
                    for (let i = 0; i < 15; i++) {
                        const bWidth = 60 + (i % 4) * 20;
                        const bHeight = 100 + (i * 71 % 150);
                        const bx = i * 200 + cityScroll - 300;
                        ctx.fillRect(bx, height - 300 - bHeight, bWidth, bHeight);
                        ctx.fillStyle = 'rgba(255,255,255,0.1)';
                        ctx.fillRect(bx + 10, height - 300 - bHeight + 10, bWidth - 20, bHeight - 20);
                        ctx.fillStyle = '#b2bec3';
                    }

                    // 5. Landmarks (Layer 4 - 0.4x scroll)
                    const landmarkScroll = sx * 0.4;
                    // Taipei 101
                    const t101X = width * 0.7 + landmarkScroll;
                    const t101BaseY = height - 300;
                    ctx.save();
                    ctx.fillStyle = '#54a0ff';
                    ctx.fillRect(t101X, t101BaseY - 450, 60, 450);
                    for (let i = 0; i < 8; i++) {
                        const sy = t101BaseY - 80 - (i * 45);
                        ctx.beginPath();
                        ctx.moveTo(t101X - 15, sy); ctx.lineTo(t101X + 75, sy);
                        ctx.lineTo(t101X + 65, sy - 35); ctx.lineTo(t101X - 5, sy - 35);
                        ctx.fill();
                        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                        ctx.strokeRect(t101X + 5, sy - 30, 50, 25);
                    }
                    ctx.fillStyle = '#2e86de';
                    ctx.fillRect(t101X + 25, t101BaseY - 500, 10, 50);
                    ctx.fillRect(t101X + 29, t101BaseY - 560, 2, 60);

                    // Breeze
                    const breezeX = width * 0.1 + landmarkScroll;
                    const breezeBaseY = height - 300;
                    ctx.fillStyle = '#00d2d3';
                    ctx.beginPath();
                    ctx.moveTo(breezeX, breezeBaseY); ctx.lineTo(breezeX, breezeBaseY - 260);
                    ctx.quadraticCurveTo(breezeX + 40, breezeBaseY - 300, breezeX + 80, breezeBaseY - 240);
                    ctx.lineTo(breezeX + 80, breezeBaseY); ctx.fill();
                    ctx.restore();

                    // 6. Ground & World (Layer 5 - 1.0x scroll)
                    // Ground (Fixed Backdrop)
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(0, height - 300, width, 300);

                    ctx.save();
                    ctx.translate(sx, 0);

                    // Shops
                    let currentStartX = 50;
                    const shopY = height - 450;
                    const shopH = 150;
                    const shopWidth = 140;
                    const gap = 20;

                    shops.forEach((shop) => {
                        drawShopStorefront(ctx, currentStartX, shopY, shopWidth, shopH, 'tea', shop.name, shop.color);
                        if (shop.isPlayer) {
                            ctx.fillStyle = '#ffeaa7'; ctx.font = '24px serif'; ctx.textAlign = 'center';
                            ctx.fillText('üëá', currentStartX + shopWidth / 2, shopY - 10);
                        }
                        currentStartX += shopWidth + gap;
                    });

                    // Pedestrians
                    const sortedPedestrians = [...pedestrians].sort((a, b) => a.depth - b.depth);
                    sortedPedestrians.forEach(p => {
                        p.x += p.speed; p.frame++;
                        const limit = 3000;
                        if (p.x > limit) p.x = -50; if (p.x < -50) p.x = limit;
                        const facing = p.speed > 0 ? 'right' : 'left';
                        const py = (height - 290) + (p.depth * 80);
                        const scale = 2.5 + (p.depth * 1.5);
                        drawPixelSprite(ctx, p.x, py, scale, p.type, p.frame, facing);
                    });

                    ctx.restore();
                    animationFrameId = requestAnimationFrame(render);
                };
                render();

                return () => {
                    window.removeEventListener('resize', resizeCanvas);
                    canvas.removeEventListener('mousedown', onDown);
                    canvas.removeEventListener('touchstart', onDown);
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('touchmove', onMove);
                    window.removeEventListener('mouseup', onUp);
                    window.removeEventListener('touchend', onUp);
                    canvas.removeEventListener('click', onClick);
                    cancelAnimationFrame(animationFrameId);
                };
            }, [shops]);

            return (
                <div className="scene-enter h-full flex flex-col relative overflow-hidden bg-sky-200">
                    <canvas
                        ref={canvasRef}
                        className="w-full h-full block cursor-grab active:cursor-grabbing"
                    />

                    {/* UI Overlay */}
                    <div className="absolute top-4 left-4 font-pixel text-white text-shadow pointer-events-none drop-shadow-md">
                        <div className="text-xl">üìç Ê∞∏ÂêâË∑Ø 30 Â∑∑</div>
                        <div className="text-xs text-stoneLight mt-1">Â∑¶Âè≥ÊªëÂãïÊé¢Á¥¢ / ÈªûÊìäÊü•ÁúãÂ∞çÊâã</div>
                    </div>

                    {selectedShop && (
                        <CompetitorModal
                            shop={selectedShop}
                            onClose={() => setSelectedShop(null)}
                        />
                    )}
                </div>
            );
        };

        // ==================== STORE SCENE (First-Person POS) ====================
        const StoreScene = ({ gameState, onServeDrink, productionSpeed = 1, onUpdateGameState, orderNumber }) => {
            const canvasRef = useRef(null);
            const [currentOrder, setCurrentOrder] = useState(null);
            const [currentGameTime, setCurrentGameTime] = useState(() => getGameTime(gameState.gameStartTime));

            // State: 'waiting' | 'approach' | 'ordering' | 'serving' | 'leaving'
            const [customerState, setCustomerState] = useState('waiting');
            const customerData = useRef({ type: 'student', x: 0, scale: 1 });
            const progressRef = useRef(0); // 0 to 100 for animations

            // Background Pedestrians
            const bgPedestrians = useRef(Array.from({ length: 5 }).map(() => ({
                x: Math.random() * 500,
                speed: (Math.random() * 0.5 + 0.5) * (Math.random() > 0.5 ? 1 : -1),
                type: ['student', 'worker', 'hipster', 'tourist'][Math.floor(Math.random() * 4)],
                frame: Math.random() * 100
            })));

            // Audio/Visual feedback placeholder
            const playDing = () => { };

            // Check business hours and update game time
            const businessOpen = isBusinessOpen(currentGameTime.gameHour, gameState.is24h);

            // Update game time periodically
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentGameTime(getGameTime(gameState.gameStartTime));
                }, 1000);
                return () => clearInterval(interval);
            }, [gameState.gameStartTime]);

            useEffect(() => {
                if (gameState.menu.length === 0) return;

                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let animationFrameId;
                let frame = 0;

                const resizeCanvas = () => {
                    const parent = canvas.parentElement;
                    if (parent && canvas) {
                        canvas.width = parent.clientWidth;
                        canvas.height = parent.clientHeight;
                    }
                };
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                // === Logic Loop ===
                const runLogic = () => {
                    // Background Pedestrians Logic
                    bgPedestrians.current.forEach(p => {
                        p.x += p.speed;
                        p.frame++;
                        const limit = canvas.width + 50;
                        if (p.x > limit) p.x = -50;
                        if (p.x < -50) p.x = limit;
                    });

                    // Check if business is open (use closure variable)
                    const gameTime = getGameTime(gameState.gameStartTime);
                    const isOpen = isBusinessOpen(gameTime.gameHour, gameState.is24h);

                    // 1. Update Game Logic
                    if (customerState === 'waiting') {
                        // Only spawn customers during business hours
                        if (isOpen && Math.random() < 0.01 * productionSpeed) {
                            customerData.current = {
                                type: ['student', 'worker', 'hipster', 'tourist'][Math.floor(Math.random() * 4)],
                                x: canvas.width / 2, // Center
                                scale: 0.5 // Start small (far)
                            };
                            setCustomerState('approach');
                            progressRef.current = 0;
                        }
                    } else if (customerState === 'approach') {
                        // Walk towards camera
                        progressRef.current += 2; // Speed
                        // Scale 0.5 -> 8
                        customerData.current.scale = 0.5 + (progressRef.current / 100) * 8;

                        if (progressRef.current >= 100) {
                            setCustomerState('ordering');
                            // Pick Order
                            const order = gameState.menu[Math.floor(Math.random() * gameState.menu.length)];
                            setCurrentOrder(order);
                            progressRef.current = 0;
                        }
                    } else if (customerState === 'ordering') {
                        // Just wait a bit for "reading menu"
                        progressRef.current++;
                        if (progressRef.current > 60) { // 1 sec
                            setCustomerState('serving');
                            progressRef.current = 0;
                        }
                    } else if (customerState === 'serving') {
                        progressRef.current += productionSpeed; // Build speed
                        if (progressRef.current >= 100) {
                            // Done!
                            const drink = currentOrder;
                            const cost = calculateDrinkCost(drink);
                            const revenue = drink.price;

                            onServeDrink(revenue, cost);

                            setCustomerState('leaving');
                            progressRef.current = 0;
                        }
                    } else if (customerState === 'leaving') {
                        progressRef.current += 2;
                        customerData.current.x += 10; // Walk right to leave
                        if (progressRef.current > 100) {
                            setCustomerState('waiting');
                            setCurrentOrder(null);
                        }
                    }
                };

                const render = () => {
                    frame++;
                    runLogic();

                    const width = canvas.width;
                    const height = canvas.height;

                    // --- DRAWING LAYERS (Ordered) ---

                    // 1. Background (Blurry Street)
                    ctx.fillStyle = '#87CEEB'; // Sky
                    ctx.fillRect(0, 0, width, height);

                    // Cityscape / Buildings (Raised for mobile visibility)
                    const horizonY = height * 0.35;  // Raise horizon line
                    ctx.fillStyle = '#dfe6e9';
                    ctx.fillRect(50, horizonY - 100, 100, 150); // Building 1
                    ctx.fillStyle = '#b2bec3';
                    ctx.fillRect(180, horizonY - 180, 140, 230); // Building 2 (taller)
                    ctx.fillStyle = '#fab1a0';
                    ctx.fillRect(width - 160, horizonY - 120, 100, 170); // Building 3
                    ctx.fillStyle = '#74b9ff';
                    ctx.fillRect(width - 280, horizonY - 80, 80, 130); // Building 4 (new)

                    // Street Floor
                    ctx.fillStyle = '#7f8c8d'; // Street
                    ctx.fillRect(0, horizonY + 50, width, height - horizonY);

                    // 2. Background Pedestrians (Walking sideways outside) - Raised and larger
                    bgPedestrians.current.forEach(p => {
                        const facing = p.speed > 0 ? 'right' : 'left';
                        drawPixelSprite(ctx, p.x, horizonY + 100, 2.2, p.type, p.frame, facing);
                    });

                    // 3. Customer Sprite (BEHIND Counter)
                    if (customerState !== 'waiting') {
                        const { x, scale, type } = customerData.current;
                        // Bob while walking
                        const bob = (customerState === 'approach' || customerState === 'leaving')
                            ? Math.sin(frame * 0.2) * 10 : 0;

                        // Facing logic for main customer
                        let facing = 'front';
                        let heldItem = null;
                        if (customerState === 'leaving') {
                            facing = 'right'; // Walk away sideways
                            heldItem = 'drink';
                        }

                        drawPixelSprite(ctx, x, height - 130 + bob, scale, type, frame, facing, heldItem);
                    }

                    // 4. Countertop (Close - Occludes lower body of customer)
                    ctx.fillStyle = '#dcdde1';
                    ctx.fillRect(0, height - 150, width, 150); // Covers bottom 150px
                    ctx.fillStyle = '#95a5a6'; // Edge
                    ctx.fillRect(0, height - 150, width, 10);

                    // 5. Drink on Counter (During Serving - On Top of Counter)
                    if (customerState === 'serving') {
                        // Fade in or slide in
                        const alpha = Math.min(1, progressRef.current / 50);
                        ctx.globalAlpha = alpha;
                        const drinkX = width * 0.2; // Move to Left
                        const drinkY = height - 100;

                        ctx.fillStyle = '#fab1a0'; // Cup
                        ctx.fillRect(drinkX, drinkY - 40, 30, 40);
                        ctx.fillStyle = '#fff'; // Lid
                        ctx.fillRect(drinkX - 2, drinkY - 45, 34, 5);

                        ctx.globalAlpha = 1.0;
                    }

                    animationFrameId = requestAnimationFrame(render);
                };
                render();

                return () => {
                    window.removeEventListener('resize', resizeCanvas);
                    cancelAnimationFrame(animationFrameId);
                };
            }, [gameState.menu, productionSpeed, customerState, gameState.gameStartTime, gameState.is24h]); // Re-bind on state change logic

            return (
                <div className="scene-enter h-full flex flex-col p-4 pt-20 pb-28 overflow-hidden relative">
                    <h2 className="font-silkscreen text-gold text-2xl mb-4 text-center z-10 drop-shadow-md">
                        {gameState.shopName}
                    </h2>

                    {/* Viewport */}
                    <div className="flex-1 relative border-4 border-dirtDark rounded-lg overflow-hidden bg-black/20 text-center">
                        <canvas
                            ref={canvasRef}
                            className="w-full h-full object-cover"
                        />

                        {/* Closed indicator */}
                        {!businessOpen && (
                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center">
                                <div className="text-center">
                                    <div className="text-6xl mb-4">üåô</div>
                                    <div className="font-pixel text-white text-2xl">‰ºëÊÅØ‰∏≠</div>
                                    <div className="font-pixel text-stoneLight text-sm mt-2">
                                        ÁáüÊ•≠ÊôÇÈñì 11:00 - 19:00
                                    </div>
                                    {!gameState.is24h && (
                                        <div className="font-pixel text-gold text-xs mt-4">
                                            üí° ÈñãÂïü 24H Áç≤ÂèñÂ§úÈñìÁáüÊî∂
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* POS Screen Overlay */}
                        <div className="absolute bottom-4 right-4 w-48 h-32 bg-stoneDark border-4 border-stone p-2 rounded shadow-xl opacity-90">
                            <div className="bg-black w-full h-full p-2 font-pixel text-left flex flex-col justify-between">
                                {currentOrder ? (
                                    <>
                                        <div className="text-grassLight text-sm">ORDER_ID: #{String(orderNumber).padStart(3, '0')}</div>
                                        <div>
                                            <div className="text-white text-lg leading-tight">{currentOrder.name}</div>
                                            <div className="text-stoneLight text-xs mt-1">
                                                {currentOrder.base} + {currentOrder.toppings.length}
                                            </div>
                                        </div>
                                        <div className="text-right text-gold text-xl border-t border-stoneDark pt-1">
                                            ${currentOrder.price}
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex items-center justify-center h-full text-stone text-center animate-pulse">
                                        {businessOpen ? 'Á≠âÂæÖÈªûÂñÆ...' : '‰ºëÊÅØ‰∏≠...'}<br />SYSTEM READY
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Bottom Info Status */}
                    <PixelPanel className="mt-4 p-4 flex justify-between items-center" variant="stone">
                        <div className="text-left">
                            <div className="font-pixel text-stoneLight text-sm">‰ªäÊó•‰æÜÂÆ¢</div>
                            <div className="font-pixel text-white text-xl">
                                {gameState.todayCustomers || 0} ‰∫∫
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="font-pixel text-stoneLight text-sm">‰ªäÊó•ÁáüÊî∂</div>
                            <div className="font-pixel text-gold text-2xl">
                                {formatMoney(gameState.todayRevenue || 0)}
                            </div>
                        </div>
                    </PixelPanel>
                </div>
            );
        };

        // ==================== MANAGE SCENE ====================
        const ManageScene = ({ gameState, onUpdateGameState, projection, metrics }) => {
            const [activeTab, setActiveTab] = useState('menu');
            const [editingDrink, setEditingDrink] = useState(null); // null = list view, object = editing
            const [drinkToDelete, setDrinkToDelete] = useState(null);
            const [rankPeriod, setRankPeriod] = useState('monthly'); // daily, monthly, total


            // --- Settings & Tabs ---

            // --- Menu Editor Components ---
            const MenuEditor = ({ drink, onSave, onCancel }) => {
                const [name, setName] = useState(drink?.name || 'Êñ∞ÂìÅÈ†Ö');
                const [base, setBase] = useState(drink?.base || INGREDIENTS.bases[0].id);
                const [toppings, setToppings] = useState(drink?.toppings || []);
                const [price, setPrice] = useState(drink?.price || 50);

                const currentCost = calculateDrinkCost({ base, toppings });
                const currentAttraction = calculateAttraction({ base, toppings });

                const toggleTopping = (tid) => {
                    if (toppings.includes(tid)) {
                        setToppings(toppings.filter(t => t !== tid));
                    } else {
                        if (toppings.length >= 3) return; // Max 3 toppings
                        setToppings([...toppings, tid]);
                    }
                };

                return (
                    <div className="flex flex-col h-full">
                        <h3 className="font-pixel text-gold text-xl mb-4">
                            {drink ? '‚úèÔ∏è Á∑®ËºØÈ£≤ÂìÅ' : '‚ú® Á†îÁôºÊñ∞ÂìÅ'}
                        </h3>

                        <div className="flex-1 overflow-y-auto space-y-4">
                            {/* Name Input */}
                            <div>
                                <label className="block font-pixel text-stone mb-1">È£≤ÂìÅÂêçÁ®±</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    maxLength={10}
                                    className="w-full bg-dirtDark border-2 border-stoneDark text-white p-2 font-pixel text-lg focus:outline-none focus:border-gold"
                                />
                            </div>

                            {/* Base Selection */}
                            <div>
                                <label className="block font-pixel text-stone mb-1">Âü∫Â∫ïËå∂</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {INGREDIENTS.bases.map(b => (
                                        <button
                                            key={b.id}
                                            onClick={() => setBase(b.id)}
                                            className={`
                                                p-2 border-2 text-left transition-colors
                                                ${base === b.id
                                                    ? 'bg-grass border-grassDark text-white'
                                                    : 'bg-stoneDark border-stone text-stoneLight'}
                                            `}
                                        >
                                            <div className="font-pixel">{b.emoji} {b.name}</div>
                                            <div className="font-pixel text-xs opacity-75">${b.cost} | ‚≠ê{b.attraction}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Toppings Selection */}
                            <div>
                                <label className="block font-pixel text-stone mb-1">ÈÖçÊñô (ÊúÄÂ§ö3Á®Æ)</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {INGREDIENTS.toppings.map(t => (
                                        <button
                                            key={t.id}
                                            onClick={() => toggleTopping(t.id)}
                                            className={`
                                                p-2 border-2 text-left transition-colors
                                                ${toppings.includes(t.id)
                                                    ? 'bg-dirt border-dirtDark text-white'
                                                    : 'bg-stoneDark border-stone text-stoneLight'}
                                            `}
                                        >
                                            <div className="font-pixel">{t.emoji} {t.name}</div>
                                            <div className="font-pixel text-xs opacity-75">${t.cost} | ‚≠ê{t.attraction}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Price Setting */}
                            <div>
                                <label className="block font-pixel text-stone mb-1">ÂîÆÂÉπËàáÂàÜÊûê</label>
                                <div className="flex items-center gap-4 mb-2">
                                    <button
                                        onClick={() => setPrice(p => Math.max(0, p - 5))}
                                        className="bg-stoneDark w-10 h-10 text-white font-bold border-2 border-stone"
                                    >-</button>
                                    <div className="flex-1 text-center bg-dirtDark p-2 border-2 border-stoneDark text-gold text-2xl font-pixel">
                                        ${price}
                                    </div>
                                    <button
                                        onClick={() => setPrice(p => p + 5)}
                                        className="bg-stoneDark w-10 h-10 text-white font-bold border-2 border-stone"
                                    >+</button>
                                </div>
                                <div className="text-sm font-pixel text-stoneLight space-y-1">
                                    <div className="flex justify-between">
                                        <span>Á∏ΩÊàêÊú¨:</span> <span className="text-white">${currentCost}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>ÂñÆÊùØÊØõÂà©:</span> <span className={price - currentCost > 0 ? 'text-grassLight' : 'text-red-400'}>${price - currentCost}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Á∏ΩÂê∏ÂºïÂäõ:</span> <span className="text-gold">{currentAttraction}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-4 pt-4 border-t-2 border-stoneDark">
                            <PixelButton variant="secondary" className="flex-1" onClick={onCancel}>ÂèñÊ∂à</PixelButton>
                            <PixelButton
                                variant="gold"
                                className="flex-1"
                                onClick={() => onSave({
                                    id: drink?.id || Date.now(),
                                    name, base, toppings, price
                                })}
                            >
                                Á¢∫ÂÆö
                            </PixelButton>
                        </div>
                    </div>
                );
            };

            // --- Upgrade Item Component ---
            const UpgradeItem = ({ id, currentLevel, data, onUpgrade }) => {
                const nextLevel = currentLevel + 1;
                const cost = data.baseCost * Math.pow(1.5, currentLevel);
                const isMax = currentLevel >= data.maxLevel;
                const canAfford = gameState.money >= cost;

                return (
                    <div className="bg-dirtDark p-3 mb-2 border-2 border-stoneDark">
                        <div className="flex justify-between items-start mb-2">
                            <div>
                                <div className="font-pixel text-white text-lg">{data.name}</div>
                                <div className="font-pixel text-stone text-sm">Lv.{currentLevel} / {data.maxLevel}</div>
                            </div>
                            <div className="text-2xl">{data.icon}</div>
                        </div>
                        <p className="font-pixel text-stoneLight text-sm mb-3 h-10 line-clamp-2">
                            {data.description}
                        </p>
                        {isMax ? (
                            <div className="bg-stoneDark text-stone text-center py-2 font-pixel border-2 border-stone">
                                Â∑≤ÈÅîÊúÄÈ´òÁ≠âÁ¥ö
                            </div>
                        ) : (
                            <PixelButton
                                variant={canAfford ? 'gold' : 'secondary'}
                                size="sm"
                                className="w-full flex justify-between items-center"
                                onClick={() => onUpgrade(id, cost)}
                                disabled={!canAfford}
                            >
                                <span>ÂçáÁ¥ö</span>
                                <span>${formatMoney(cost)}</span>
                            </PixelButton>
                        )}
                    </div>
                );
            };

            const StaffCard = ({ title, count, salary, type }) => (
                <div className="bg-dirtDark p-3 mb-2 border-2 border-stoneDark flex justify-between items-center">
                    <div>
                        <div className="font-pixel text-white text-lg">{title}</div>
                        <div className="font-pixel text-stone text-sm">${formatMoney(salary)}/Êúà</div>
                    </div>
                    <div className="flex items-center gap-3">
                        <PixelButton
                            variant="secondary"
                            size="sm"
                            disabled={count <= 0}
                            onClick={() => {
                                onUpdateGameState(prev => ({
                                    ...prev,
                                    staff: { ...prev.staff, [type]: prev.staff[type] - 1 }
                                }));
                            }}
                        >-</PixelButton>
                        <span className="font-pixel text-xl w-6 text-center">{count}</span>
                        <PixelButton
                            variant="primary"
                            size="sm"
                            onClick={() => {
                                onUpdateGameState(prev => ({
                                    ...prev,
                                    staff: { ...prev.staff, [type]: prev.staff[type] + 1 }
                                }));
                            }}
                        >+</PixelButton>
                    </div>
                </div>
            );



            const tabs = [
                { id: 'menu', label: 'ËèúÂñÆ', icon: 'üçπ' },
                { id: 'equipment', label: 'Ë®≠ÂÇô', icon: '‚öôÔ∏è' },
                { id: 'staff', label: '‰∫∫‰∫ã', icon: 'üë•' },
                { id: 'finance', label: 'Ë≤°Âãô', icon: 'üíπ' },
                { id: 'rank', label: 'ÊéíË°å', icon: 'üèÜ' },
            ];

            return (
                <div className="scene-enter h-full flex flex-col p-4 pt-20 pb-28">
                    {!editingDrink && (
                        <PixelTab tabs={tabs} activeTab={activeTab} onTabChange={setActiveTab} />
                    )}

                    <PixelPanel className="flex-1 mt-0 p-4 overflow-y-auto">
                        {/* MENU EDITOR MODE */}
                        {editingDrink && typeof editingDrink === 'object' && (
                            <MenuEditor
                                drink={editingDrink.id ? editingDrink : null}
                                onCancel={() => setEditingDrink(null)}
                                onSave={(newDrink) => {
                                    onUpdateGameState(prev => {
                                        const isNew = !prev.menu.find(d => d.id === newDrink.id);
                                        let newMenu = isNew ? [...prev.menu, newDrink] : prev.menu.map(d => d.id === newDrink.id ? newDrink : d);
                                        return { ...prev, menu: newMenu };
                                    });
                                    setEditingDrink(null);
                                }}
                            />
                        )}

                        {/* NORMAL TABS */}
                        {!editingDrink && activeTab === 'menu' && (
                            <div>
                                <h3 className="font-pixel text-gold text-xl mb-4">üìú ËèúÂñÆÁÆ°ÁêÜ ({gameState.menu.length}/10)</h3>
                                {gameState.menu.map((drink) => (
                                    <div key={drink.id} className="bg-dirtDark p-3 mb-2 border-2 border-stoneDark relative group">
                                        <div className="flex justify-between items-center">
                                            <span className="font-pixel text-white text-lg">
                                                üßã {drink.name}
                                            </span>
                                            <span className="font-pixel text-gold text-lg">
                                                ${drink.price}
                                            </span>
                                        </div>
                                        <div className="font-pixel text-stone text-sm mt-1 mb-2">
                                            ÊàêÊú¨: ${calculateDrinkCost(drink)} |
                                            Âê∏ÂºïÂäõ: {calculateAttraction(drink)}
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setEditingDrink(drink)}
                                                className="flex-1 bg-stoneDark text-white font-pixel py-1 border-2 border-stone hover:bg-stone"
                                            >
                                                Á∑®ËºØ
                                            </button>
                                            <button
                                                onClick={() => setDrinkToDelete(drink)}
                                                className="flex-1 bg-red-900 text-red-100 font-pixel py-1 border-2 border-red-800 hover:bg-red-800"
                                            >
                                                Âà™Èô§
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {gameState.menu.length < 10 ? (
                                    <PixelButton
                                        variant="secondary"
                                        size="sm"
                                        className="w-full mt-4"
                                        onClick={() => setEditingDrink({})}
                                    >
                                        + Êñ∞Â¢ûÈ£≤ÂìÅ
                                    </PixelButton>
                                ) : (
                                    <div className="text-center font-pixel text-stone mt-4">ËèúÂñÆÂ∑≤Êªø</div>
                                )}
                            </div>
                        )}

                        {!editingDrink && activeTab === 'equipment' && (
                            <div>
                                <h3 className="font-pixel text-gold text-xl mb-4">‚öôÔ∏è Ë®≠ÂÇôÂçáÁ¥ö</h3>
                                {[
                                    { id: 'teaMachine', name: 'ËêÉËå∂Ê©ü', icon: '‚ô®Ô∏è', description: 'Âä†Âø´Ë£Ω‰ΩúÈÄüÂ∫¶ÔºåÊèêÂçáÈ°ßÂÆ¢ÁøªÊ°åÁéá„ÄÇ', maxLevel: 5, baseCost: 2000 },
                                    { id: 'iceMachine', name: 'Ë£ΩÂÜ∞Ê©ü', icon: '‚ùÑÔ∏è', description: 'ÊèêÂçáÈ£≤ÂìÅÂìÅË≥™ÔºåÂæÆÂπÖÂ¢ûÂä†Âê∏ÂºïÂäõËàáËΩâÂåñÁéá„ÄÇ', maxLevel: 3, baseCost: 5000 },
                                    { id: 'sealingMachine', name: 'Â∞ÅÂè£Ê©ü', icon: 'ü•§', description: 'Âä†Âø´ÊâìÂåÖÈÄüÂ∫¶ÔºåÈÄ≤‰∏ÄÊ≠•ÊèêÂçáË£Ω‰ΩúÊïàÁéá„ÄÇ', maxLevel: 5, baseCost: 1500 },
                                    { id: 'marketing', name: 'Á§æÁæ§Ë°åÈä∑', icon: 'üì¢', description: 'ÊèêÂçáÂìÅÁâåÁü•ÂêçÂ∫¶ÔºåÂ¢ûÂä†Âü∫Á§éÈÅéË∑ØÂÆ¢ÊµÅÈáè„ÄÇ', maxLevel: 10, baseCost: 3000 }, // New pseudo-equipment
                                ].map(item => (
                                    <UpgradeItem
                                        key={item.id}
                                        id={item.id}
                                        currentLevel={gameState.equipment[item.id] || 0}
                                        data={item}
                                        onUpgrade={(id, cost) => {
                                            onUpdateGameState(prev => ({
                                                ...prev,
                                                money: prev.money - cost,
                                                equipment: {
                                                    ...prev.equipment,
                                                    [id]: (prev.equipment[id] || 0) + 1
                                                }
                                            }));
                                        }}
                                    />
                                ))}
                            </div>
                        )}

                        {!editingDrink && activeTab === 'staff' && (
                            <div>
                                <h3 className="font-pixel text-gold text-xl mb-4">üë• ‰∫∫ÂäõË≥áÊ∫ê</h3>
                                <div className="mb-6 p-3 bg-dirt border-2 border-dirtDark">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="font-pixel text-white text-lg">24Â∞èÊôÇÁáüÊ•≠</span>
                                        <button
                                            onClick={() => onUpdateGameState(prev => ({ ...prev, is24h: !prev.is24h }))}
                                            className={`
                                                w-16 h-8 rounded-full border-2 transition-colors relative
                                                ${gameState.is24h ? 'bg-grass border-grassDark' : 'bg-stoneDark border-stone'}
                                            `}
                                        >
                                            <div className={`
                                                absolute top-1 w-5 h-5 bg-white rounded-full transition-all
                                                ${gameState.is24h ? 'right-1' : 'left-1'}
                                            `}></div>
                                        </button>
                                    </div>
                                    <p className="font-pixel text-stoneLight text-sm">
                                        ÈñãÂïüÂæåÈúÄÊáâÂ∞ç‰∏âÁè≠Âà∂ÊéíÁè≠„ÄÇÁêÜÊÉ≥ÈÖçÁΩÆÔºöÊØèÁè≠ 1 Ê≠£ËÅ∑ + 1 ÂÖºËÅ∑„ÄÇ
                                        {gameState.is24h && (
                                            <div className="mt-2 space-y-1 bg-black/30 p-2 border border-stoneDark">
                                                <div className="flex justify-between">
                                                    <span>ÊéíÁè≠Ë¶ÜËìãÁéá:</span>
                                                    <span className={metrics.efficiencyBreakdown.coverage < 1 ? 'text-red-400' : 'text-grassLight'}>
                                                        {Math.round(metrics.efficiencyBreakdown.coverage * 100)}%
                                                    </span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>ÁÆ°ÁêÜÊïàÁõä:</span>
                                                    <span className={metrics.efficiencyBreakdown.manager < 1 ? 'text-red-400' : 'text-grassLight'}>
                                                        x{metrics.efficiencyBreakdown.manager.toFixed(1)}
                                                    </span>
                                                </div>
                                                {metrics.efficiencyBreakdown.overcrowding > 0 && (
                                                    <div className="flex justify-between text-red-400">
                                                        <span>ÊìÅÊì†Êá≤ÁΩ∞:</span>
                                                        <span>-{Math.round(metrics.efficiencyBreakdown.overcrowding * 100)}%</span>
                                                    </div>
                                                )}
                                                <div className="border-t border-stoneDark my-1"></div>
                                                <div className="flex justify-between font-bold text-white">
                                                    <span>ÊúÄÁµÇÊïàÁéá:</span>
                                                    <span>{Math.round(metrics.efficiencyBreakdown.total * 100)}%</span>
                                                </div>
                                            </div>
                                        )}
                                    </p>
                                </div>

                                <StaffCard title="Â∑•ËÆÄÁîü (Part-time)" count={gameState.staff.partTime} salary={35000} type="partTime" />
                                <StaffCard title="Ê≠£ËÅ∑‰∫∫Âì° (Full-time)" count={gameState.staff.fullTime} salary={45000} type="fullTime" />
                                <StaffCard title="Â∫óÁ∂ìÁêÜ (Manager)" count={gameState.staff.manager} salary={60000} type="manager" />
                            </div>
                        )}

                        {!editingDrink && activeTab === 'finance' && (
                            <div>
                                <h3 className="font-pixel text-gold text-xl mb-4">üíπ Ë≤°ÂãôÂ†±Ë°®</h3>
                                <div className="space-y-3 px-1">
                                    <div className="bg-dirtDark p-3 border-2 border-stoneDark">
                                        <div className="font-pixel text-stone">ÁèæÈáëË≥áÁî¢</div>
                                        <div className="font-pixel text-gold text-2xl">
                                            {formatMoney(gameState.money)}
                                        </div>
                                    </div>

                                    <div className="bg-dirtDark p-3 border-2 border-stoneDark">
                                        <div className="font-pixel text-white mb-2 border-b border-stoneDark pb-1">Êú¨ÊúàÁáüÈÅãÂàÜÊûê (È†ê‰º∞)</div>

                                        <div className="space-y-2">
                                            <div className="flex justify-between font-pixel">
                                                <span className="text-stone">Á∏ΩÁáüÊî∂</span>
                                                <span className="text-grassLight">{formatMoney(metrics.details.revenue)}</span>
                                            </div>

                                            <div className="flex justify-between font-pixel">
                                                <span className="text-stone">ÂéüÁâ©ÊñôÊàêÊú¨ (COGS)</span>
                                                <span className="text-red-300">-{formatMoney(metrics.details.cogs)}</span>
                                            </div>

                                            <div className="border-t border-dashed border-stoneDark my-1"></div>

                                            <div className="flex justify-between font-pixel text-sm">
                                                <span className="text-stoneLight">Â∫óÂ∫ïÁßüÈáë</span>
                                                <span className="text-red-400">-{formatMoney(metrics.details.rent)}</span>
                                            </div>

                                            <div className="flex justify-between font-pixel text-sm">
                                                <span className="text-stoneLight">‰∫∫ÂäõËñ™Ë≥á</span>
                                                <span className="text-red-400">-{formatMoney(metrics.details.staff)}</span>
                                            </div>

                                            <div className="flex justify-between font-pixel text-sm">
                                                <span className="text-stoneLight">Ê∞¥ÈõªÈõúË≤ª ({gameState.is24h ? '24H' : 'Ê®ôÊ∫ñ'})</span>
                                                <span className="text-red-400">-{formatMoney(metrics.details.utilities)}</span>
                                            </div>

                                            <div className="flex justify-between font-pixel text-sm">
                                                <span className="text-stoneLight">Ë®≠ÂÇôÁ∂≠Ë≠∑Ë≤ª</span>
                                                <span className="text-red-400">-{formatMoney(metrics.details.maintenance)}</span>
                                            </div>

                                            <div className="border-t-2 border-stoneDark pt-2 mt-2 flex justify-between font-pixel text-lg">
                                                <span className="text-white">Êú¨ÊúàÈ†êË®àÊ∑®Âà©</span>
                                                <span className={projection >= 0 ? 'text-gold' : 'text-red-500'}>
                                                    {formatMoney(projection)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="text-center font-pixel text-stone text-xs italic">
                                        * Êï∏ÊìöÈö®Èä∑ÈáèËàáÁáüÈÅãÈÖçÁΩÆÂç≥ÊôÇËÆäÂãï
                                    </div>
                                </div>
                            </div>
                        )}

                        {!editingDrink && activeTab === 'rank' && (
                            <div className="space-y-2">
                                <h3 className="font-pixel text-gold text-xl mb-4">üèÜ ÊéíË°åÊ¶ú</h3>

                                {/* Sub-tabs */}
                                <div className="flex gap-2 mb-4">
                                    {['daily', 'monthly', 'total'].map(p => (
                                        <button
                                            key={p}
                                            onClick={() => setRankPeriod(p)}
                                            className={`flex-1 py-1 font-pixel text-sm border-2 ${rankPeriod === p
                                                ? 'bg-gold text-dirtDark border-white'
                                                : 'bg-dirtDark text-stone border-stoneDark'
                                                }`}
                                        >
                                            {{ daily: 'ÊØèÊó•', monthly: 'ÊØèÊúà', total: 'Á¥ØÁ©ç' }[p]}
                                        </button>
                                    ))}
                                </div>

                                {(() => {
                                    // Prepare Data
                                    const getMetric = (c, isPlayer) => {
                                        if (isPlayer) return gameState.metrics?.[rankPeriod] || 0;
                                        // AI Logic
                                        if (rankPeriod === 'daily') return Math.round(c.monthlyRevenue / 30);
                                        if (rankPeriod === 'total') return c.monthlyRevenue * 12;
                                        return c.monthlyRevenue;
                                    };

                                    const list = [
                                        ...(gameState.competitors || []).map(c => ({ ...c, isPlayer: false })),
                                        { id: 'player', name: gameState.shopName, isPlayer: true, color: '#e17055', tier: 'Áé©ÂÆ∂' }
                                    ].map(c => ({
                                        ...c,
                                        value: getMetric(c, c.isPlayer)
                                    })).sort((a, b) => b.value - a.value);

                                    return list.map((shop, i) => (
                                        <div
                                            key={shop.id}
                                            className={`p-3 border-2 flex justify-between items-center ${shop.isPlayer
                                                ? 'bg-grass border-grassDark'
                                                : 'bg-dirtDark border-stoneDark'
                                                }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <span className={`font-pixel text-xl ${shop.isPlayer ? 'text-white' : 'text-gold'}`}>
                                                    #{i + 1}
                                                </span>
                                                <span className="font-pixel text-white">{shop.name}</span>
                                            </div>
                                            <div className="text-right">
                                                <div className={`font-pixel ${shop.isPlayer ? 'text-white' : 'text-goldLight'}`}>
                                                    {formatMoney(shop.value)}
                                                </div>
                                                <div className="font-pixel text-sm" style={{ color: shop.color }}>
                                                    {shop.tier}
                                                </div>
                                            </div>
                                        </div>
                                    ));
                                })()}
                            </div>
                        )}
                        {drinkToDelete && (
                            <DialogModal
                                title="Âà™Èô§Á¢∫Ë™ç"
                                message={`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${drinkToDelete.name} ÂóéÔºü`}
                                confirmText="Âà™Èô§"
                                variant="stone"
                                onCancel={() => setDrinkToDelete(null)}
                                onConfirm={() => {
                                    onUpdateGameState(prev => ({
                                        ...prev,
                                        menu: prev.menu.filter(m => m.id !== drinkToDelete.id)
                                    }));
                                    setDrinkToDelete(null);
                                }}
                            />
                        )}
                    </PixelPanel>
                </div>
            );
        };

        const INITIAL_STATE = {
            shopName: 'ÊàëÁöÑÊâãÊêñÂ∫ó', // Default name
            hasStarted: false, // Onboarding flag
            money: 100000,
            reputation: 0,
            todayRevenue: 0, // Today's revenue for store display
            todayCustomers: 0, // Today's customer count
            gameStartTime: Date.now(), // Game start timestamp for time calculation
            lastGameDay: 1, // Track last game day for daily reset
            lastGameMonth: 1, // Track last game month for daily reset
            lastOrderNumber: 0, // Sequential order ID for POS
            metrics: { daily: 0, monthly: 0, total: 0 },
            menu: [
                { id: 1, base: 'black-tea', toppings: ['boba'], price: 45, name: 'ÁèçÁè†Á¥ÖËå∂' },
                { id: 2, base: 'green-tea', toppings: [], price: 25, name: 'Á¥îÁ∂†Ëå∂' },
            ],
            equipment: {
                teaMachine: 1,
                iceMachine: 1,
                sealingMachine: 1,
                marketing: 0,
            },
            staff: {
                partTime: 1,
                fullTime: 0,
                manager: 0,
            },
            financials: {
                rent: 50000,
            },
            competitors: AI_COMPETITORS, // Dynamic copy
            is24h: false,
            lastOnline: Date.now(),
        };

        // ==================== OFFLINE REPORT MODAL ====================
        const OfflineReport = ({ data, onClose }) => {
            if (!data) return null;
            return (
                <div className="absolute inset-0 bg-black/90 z-[60] flex items-center justify-center p-6">
                    <PixelPanel className="w-full max-w-sm p-6" variant="gold">
                        <h2 className="font-silkscreen text-dirtDark text-2xl mb-4 text-center">
                            üò¥ Èõ¢Á∑öÂ†±Âëä
                        </h2>
                        <div className="space-y-4 mb-6">
                            <div className="bg-white/50 p-3 rounded border-2 border-dirtDark">
                                <div className="font-pixel text-dirtDark text-lg text-center mb-1">Èõ¢Á∑öÊôÇÈñì</div>
                                <div className="font-pixel text-dirtDark text-3xl text-center font-bold">
                                    {data.hours.toFixed(1)} <span className="text-sm">Â∞èÊôÇ</span>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between font-pixel text-xl text-dirtDark">
                                    <span>Á∏ΩÁáüÊî∂</span>
                                    <span className="text-grassDark">+${formatMoney(data.revenue)}</span>
                                </div>
                                <div className="flex justify-between font-pixel text-lg text-red-700">
                                    <span>ÊàêÊú¨ËàáÊîØÂá∫</span>
                                    <span>-${formatMoney(data.expenses)}</span>
                                </div>
                                <div className="border-t-2 border-dashed border-dirtDark my-2"></div>
                                <div className="flex justify-between font-pixel text-2xl font-bold text-dirtDark">
                                    <span>Ê∑®Âà©ÊΩ§</span>
                                    <span className={data.net >= 0 ? 'text-grassDark' : 'text-red-700'}>
                                        {data.net >= 0 ? '+' : ''}${formatMoney(data.net)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <PixelButton variant="primary" className="w-full" onClick={onClose}>
                            Êî∂‰∏ãÁèæÈáë
                        </PixelButton>
                    </PixelPanel>
                </div>
            );
        };

        const DialogModal = ({ title, message, onConfirm, onCancel, confirmText = 'Á¢∫ÂÆö', cancelText = 'ÂèñÊ∂à', variant = 'dirt' }) => (
            <div className="absolute inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
                <PixelPanel className="w-full max-w-sm p-6" variant={variant}>
                    <h2 className="font-silkscreen text-gold text-xl mb-4 text-center">{title}</h2>
                    <p className="font-pixel text-white text-lg mb-6 text-center">{message}</p>
                    <div className="flex gap-4">
                        {onCancel && (
                            <PixelButton variant="secondary" className="flex-1" onClick={onCancel}>
                                {cancelText}
                            </PixelButton>
                        )}
                        <PixelButton variant="primary" className="flex-1" onClick={onConfirm}>
                            {confirmText}
                        </PixelButton>
                    </div>
                </PixelPanel>
            </div>
        );

        // ==================== INTRO SCENE ====================
        const IntroScene = ({ onStart }) => {
            const [step, setStep] = useState(0);
            const [shopName, setShopName] = useState('');

            const story = [
                { text: "2024Âπ¥ÔºåÂè∞Âåó...", icon: "üèôÔ∏è" },
                { text: "‰ø°Áæ©ÂçÄÔºåÊ∞∏ÂêâË∑Ø30Â∑∑...", icon: "üõµ" },
                { text: "ÈÄôË£°ÊòØÊâãÊêñÈ£≤ÁöÑ‰∏ÄÁ¥öÊà∞ÂçÄ„ÄÇ", icon: "‚öîÔ∏è" },
                { text: "ÁÑ°Êï∏ÂìÅÁâåÂú®Ê≠§Â¥õËµ∑Ôºå‰πüÂú®Ê≠§ÊÆûËêΩ„ÄÇ", icon: "üìâ" },
                { text: "ËÄå‰Ω†ÔºåÊ±∫ÂÆöÂ∏∂ËëóÈÄôÁ≠ÜÁ©çËìÑ...", icon: "üí∞" },
                { text: "Âú®ÈÄôË£°ÂâµÈÄ†Â±¨Êñº‰Ω†ÁöÑÂÇ≥Â•áÔºÅ", icon: "üëë" },
            ];

            const nextStep = () => {
                if (step < story.length) {
                    setStep(step + 1);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (shopName.trim()) {
                    onStart(shopName);
                }
            };

            return (
                <div className="absolute inset-0 bg-black z-[100] flex flex-col items-center justify-center p-6 scene-enter text-center">
                    {step < story.length ? (
                        <div onClick={nextStep} className="cursor-pointer w-full h-full flex flex-col items-center justify-center">
                            <div className="text-6xl mb-6 float-animation">{story[step].icon}</div>
                            <p className="font-pixel text-white text-2xl mb-8 leading-relaxed typing-effect">
                                {story[step].text}
                            </p>
                            <div className="font-pixel text-stone animate-pulse text-sm mt-10">
                                ÈªûÊìäÁπºÁ∫å...
                            </div>
                        </div>
                    ) : (
                        <div className="w-full max-w-sm animate-fade-in">
                            <h2 className="font-silkscreen text-gold text-2xl mb-6">ÈñãÂ∫óÊ∫ñÂÇô</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block font-pixel text-stoneLight mb-2 text-left">Ê±∫ÂÆö‰Ω†ÁöÑÂ∫óÂêç</label>
                                    <input
                                        type="text"
                                        value={shopName}
                                        onChange={(e) => setShopName(e.target.value)}
                                        placeholder="‰æãÔºöË∂ÖÁ¥öÂ•ΩÂñùËå∂"
                                        maxLength={10}
                                        className="w-full bg-dirtDark border-4 border-stone text-white p-3 font-pixel text-xl focus:border-gold outline-none"
                                        autoFocus
                                    />
                                </div>
                                <PixelButton
                                    variant="gold"
                                    size="lg"
                                    className="w-full mt-4"
                                    disabled={!shopName.trim()}
                                >
                                    ÈñãÊ•≠ÔºÅ üéä
                                </PixelButton>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        // ==================== MAIN APP ====================
        const App = () => {
            const [currentScene, setCurrentScene] = useState('store');
            const [offlineReport, setOfflineReport] = useState(null);
            const [showMenu, setShowMenu] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            // Helper: Calculate standard finance metrics from state
            const calculateFinance = (state) => {
                const emptyBreakdown = { total: 1, coverage: 1, manager: 1, overcrowding: 0 };
                const emptyDetails = { revenue: 0, cogs: 0, rent: state.financials.rent, staff: 0, utilities: 0, maintenance: 0 };

                if (state.menu.length === 0) {
                    return {
                        hourlyProfit: 0,
                        monthlyProjection: -state.financials.rent,
                        productionSpeed: 1,
                        grossRevenueMonthly: 0,
                        monthlyExpenses: state.financials.rent,
                        details: emptyDetails,
                        efficiencyBreakdown: emptyBreakdown
                    };
                }

                const avgPrice = state.menu.reduce((sum, d) => sum + d.price, 0) / state.menu.length;
                const avgCost = state.menu.reduce((sum, d) => sum + calculateDrinkCost(d), 0) / state.menu.length;
                const avgAttraction = state.menu.reduce((sum, d) => sum + calculateAttraction(d), 0) / state.menu.length;

                // Equipment bonuses
                const speedBonus = (state.equipment.teaMachine * 0.2) + (state.equipment.sealingMachine * 0.2);
                const qualityBonus = state.equipment.iceMachine * 0.1;
                const marketingBonus = state.equipment.marketing * 0.05;

                // --- ADVANCED STAFFING LOGIC ---
                const ft = state.staff.fullTime || 0;
                const pt = state.staff.partTime || 0;
                const mgr = state.staff.manager || 0;
                const workers = ft + pt;
                const totalStaff = workers + mgr;

                const shiftsNeeded = state.is24h ? 3 : 1;
                const idealFT = shiftsNeeded * 1;
                const idealPT = shiftsNeeded * 1;

                // 1. Coverage Efficiency (How well are shifts covered?)
                const ftCoverage = Math.min(1, ft / idealFT);
                const ptCoverage = Math.min(1, pt / idealPT);
                const baseCoverage = (ftCoverage * 0.6 + ptCoverage * 0.4); // FT is more critical

                // 2. Manager Impact (Coordination)
                let managerImpact = 1.0;
                if (workers > 2 && mgr === 0) {
                    managerImpact = 0.8; // Penalty for no manager
                } else if (mgr > 0) {
                    managerImpact = 1.1; // Bonus for having a manager
                }

                // 3. Overcrowding Penalty (Space)
                const capacity = 8;
                let overcrowdingPenalty = 0;
                if (totalStaff > capacity) {
                    overcrowdingPenalty = (totalStaff - capacity) * 0.15;
                }

                // Final Efficiency Factor
                const efficiencyFactor = Math.max(0.1, (baseCoverage * managerImpact) - overcrowdingPenalty);
                const productionSpeed = (1 + speedBonus) * efficiencyFactor;
                // ------------------------------

                const baseTraffic = 100 * (1 + (state.reputation / 1000)) * (1 + marketingBonus);
                const conversionRate = Math.min(0.8, (0.3 + (avgAttraction / 100) + qualityBonus));

                // Efficiency affects volume (can't serve everyone if staff is low)
                const hourlyVolume = baseTraffic * conversionRate * (1 + speedBonus) * efficiencyFactor;

                // 24H Logic: Night traffic drops to 30%, but runs for 14 extra hours
                const dayHours = 10;
                const nightHours = state.is24h ? 14 : 0;
                const weightedVolume = (hourlyVolume * dayHours) + (hourlyVolume * 0.3 * nightHours);
                const avgVolumePerHour = weightedVolume / (dayHours + nightHours || 1);

                const monthlyVolume = weightedVolume * 30; // 30 days projection

                // --- DETAILED COSTS ---
                // 1. Ingredients (COGS)
                const monthlyCOGS = Math.round(monthlyVolume * avgCost);

                // 2. Utilities (Ê∞¥Èõª)
                let utilitiesBase = 2000;
                if (state.is24h) utilitiesBase += 1500;
                const utilitiesVariable = monthlyVolume * 1.0; // $1 per drink
                const monthlyUtilities = Math.round(utilitiesBase + utilitiesVariable);

                // 3. Maintenance (Ë®≠ÂÇôÁ∂≠‰øÆ)
                const equipmentLvSum = Object.values(state.equipment).reduce((a, b) => a + b, 0);
                const monthlyMaintenance = equipmentLvSum * 500;

                // 4. Existing Fixed Costs
                const rent = state.financials.rent;
                const staffCost = Math.round((pt * 35000) + (ft * 45000) + (mgr * 60000));
                // ----------------------

                const grossRevenueMonthly = Math.round(monthlyVolume * avgPrice);
                const monthlyExpenses = Math.round(rent + staffCost + monthlyCOGS + monthlyUtilities + monthlyMaintenance);
                const monthlyProjection = grossRevenueMonthly - monthlyExpenses;

                return {
                    hourlyProfit: Math.round(avgVolumePerHour * (avgPrice - avgCost)),
                    monthlyProjection,
                    productionSpeed,
                    monthlyExpenses,
                    grossRevenueMonthly,
                    details: {
                        revenue: grossRevenueMonthly,
                        cogs: monthlyCOGS,
                        rent: rent,
                        staff: staffCost,
                        utilities: monthlyUtilities,
                        maintenance: monthlyMaintenance
                    },
                    efficiencyBreakdown: {
                        total: efficiencyFactor,
                        coverage: baseCoverage,
                        manager: managerImpact,
                        overcrowding: overcrowdingPenalty
                    }
                };
            };

            const [gameState, setGameState] = useState(() => {
                const saved = localStorage.getItem('bobaKingState');
                let parsed = INITIAL_STATE;

                if (saved) {
                    try {
                        const savedObj = JSON.parse(saved);
                        parsed = {
                            ...INITIAL_STATE,
                            ...savedObj,
                            equipment: { ...INITIAL_STATE.equipment, ...savedObj.equipment },
                            financials: { ...INITIAL_STATE.financials, ...savedObj.financials },
                            competitors: savedObj.competitors || INITIAL_STATE.competitors
                        };
                    } catch (e) {
                        console.error("Save error", e);
                    }
                }
                return parsed;
            });

            // Initialize: Check for offline earnings and simulate competitors ONCE on mount
            useEffect(() => {
                const now = Date.now();
                const { gameDay, gameHour } = getGameTime(gameState.gameStartTime);
                const gameMonth = Math.floor((gameDay - 1) / 30) + 1;

                // 1. Metric Reset Check (Day/Month)
                let updatedMetrics = { ...gameState.metrics };
                let dayChanged = gameDay > (gameState.lastGameDay || 0);
                let monthChanged = gameMonth > (gameState.lastGameMonth || 0);

                if (dayChanged) {
                    updatedMetrics.daily = 0;
                }
                if (monthChanged) {
                    updatedMetrics.monthly = 0;
                }

                // 2. Offline Calculation
                const lastTime = gameState.lastOnline;
                const offlineHoursReal = (now - lastTime) / (1000 * 60 * 60);
                const gameHoursPerRealHour = 24 / GAME_TIME.REAL_HOURS_PER_GAME_DAY;
                const offlineHoursGame = offlineHoursReal * gameHoursPerRealHour;

                let offlineNet = 0;
                let offlineRevenue = 0;

                if (offlineHoursReal > 0.05) {
                    const finance = calculateFinance(gameState);
                    // Conversion: grossRevenueMonthly / (30 days * 24 hours per day)
                    const hourlyRevenue = finance.grossRevenueMonthly / (30 * 24);
                    const hourlyExpenses = finance.monthlyExpenses / (30 * 24);

                    const offlineExpenses = hourlyExpenses * offlineHoursGame;
                    offlineRevenue = hourlyRevenue * offlineHoursGame;
                    offlineNet = offlineRevenue - offlineExpenses;

                    setOfflineReport({
                        hours: offlineHoursGame, // Show game hours in report for consistency
                        revenue: Math.round(offlineRevenue),
                        expenses: Math.round(offlineExpenses),
                        net: Math.round(offlineNet)
                    });

                    // Add offline revenue to metrics
                    updatedMetrics.daily += offlineRevenue;
                    updatedMetrics.monthly += offlineRevenue;
                    updatedMetrics.total += offlineRevenue;
                }

                // 3. Update Game State once on mount
                setGameState(prev => {
                    // 4. Simulate Competitors (Only on day change or if new session)
                    const shouldFluctuate = dayChanged || !prev.lastOnline;
                    const newCompetitors = shouldFluctuate
                        ? prev.competitors.map(c => ({
                            ...c,
                            monthlyRevenue: Math.round(c.monthlyRevenue * (0.95 + Math.random() * 0.1)) // 0.95 ~ 1.05
                        })).sort((a, b) => b.monthlyRevenue - a.monthlyRevenue)
                        : prev.competitors;

                    return {
                        ...prev,
                        money: prev.money + Math.round(offlineNet),
                        lastGameDay: gameDay,
                        lastGameMonth: gameMonth,
                        lastOrderNumber: dayChanged ? 0 : (prev.lastOrderNumber || 0),
                        todayRevenue: dayChanged ? 0 : prev.todayRevenue,
                        todayCustomers: dayChanged ? 0 : prev.todayCustomers,
                        metrics: updatedMetrics,
                        competitors: newCompetitors
                    };
                });

            }, []); // Empty deps = run once on mount

            // Auto-save & Global Day Reset Check
            useEffect(() => {
                const saveState = { ...gameState, lastOnline: Date.now() };
                localStorage.setItem('bobaKingState', JSON.stringify(saveState));

                // Global day check interval (runs every 10s to see if day changed)
                const interval = setInterval(() => {
                    const { gameDay, gameHour } = getGameTime(gameState.gameStartTime);
                    const gameMonth = Math.floor((gameDay - 1) / 30) + 1;

                    if (gameDay !== gameState.lastGameDay) {
                        setGameState(prev => {
                            const isNewMonth = (gameDay - 1) % 30 === 0 && gameDay > 1;
                            return {
                                ...prev,
                                lastGameDay: gameDay,
                                lastGameMonth: gameMonth,
                                todayRevenue: 0,
                                todayCustomers: 0,
                                lastOrderNumber: 0,
                                metrics: {
                                    ...prev.metrics,
                                    daily: 0,
                                    monthly: isNewMonth ? 0 : prev.metrics.monthly
                                }
                            };
                        });
                    }
                }, 10000);

                return () => clearInterval(interval);
            }, [gameState]);

            const handleServeDrink = (revenue, cost) => {
                const profit = revenue - cost;
                setGameState(prev => {
                    const nextOrder = (prev.lastOrderNumber || 0) + 1;
                    return {
                        ...prev,
                        money: prev.money + profit, // Cash tracks Profit
                        todayRevenue: (prev.todayRevenue || 0) + revenue, // Today's revenue for store display
                        todayCustomers: (prev.todayCustomers || 0) + 1, // Today's customer count
                        lastOrderNumber: nextOrder > 999 ? 1 : nextOrder, // 3-digit wrapping logic
                        metrics: {
                            daily: (prev.metrics?.daily || 0) + revenue,
                            monthly: (prev.metrics?.monthly || 0) + revenue,
                            total: (prev.metrics?.total || 0) + revenue
                        },
                        reputation: prev.reputation + 1,
                    };
                });
            };

            const metrics = calculateFinance(gameState);

            if (!gameState.hasStarted) {
                return (
                    <IntroScene
                        onStart={(name) => {
                            // Start at 11:00 AM for new players
                            const startHour = 11;
                            const gameHoursPerRealHour = 24 / GAME_TIME.REAL_HOURS_PER_GAME_DAY;
                            const startTimeOffsetMs = (startHour / gameHoursPerRealHour) * 3600000;

                            setGameState(prev => ({
                                ...prev,
                                shopName: name,
                                hasStarted: true,
                                gameStartTime: Date.now() - startTimeOffsetMs
                            }));
                        }}
                    />
                );
            }

            return (
                <div className="w-full h-full bg-gradient-to-b from-dirtDark to-black relative">
                    <GameHUD gameState={gameState} onMenuClick={() => setShowMenu(true)} />

                    {currentScene === 'street' && <StreetScene gameState={gameState} />}
                    {currentScene === 'store' && (
                        <StoreScene
                            gameState={gameState}
                            onServeDrink={handleServeDrink}
                            productionSpeed={metrics.productionSpeed}
                            onUpdateGameState={setGameState}
                            orderNumber={(gameState.lastOrderNumber || 0) + 1}
                        />
                    )}
                    {currentScene === 'manage' && (
                        <ManageScene
                            gameState={gameState}
                            onUpdateGameState={setGameState}
                            projection={metrics.monthlyProjection}
                            metrics={metrics}
                        />
                    )}

                    <NavigationBar currentScene={currentScene} onSceneChange={setCurrentScene} />

                    {/* Offline Report */}
                    {offlineReport && (
                        <OfflineReport
                            data={offlineReport}
                            onClose={() => setOfflineReport(null)}
                        />
                    )}

                    {/* Settings Menu Modal */}
                    {showMenu && (
                        <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-8">
                            <PixelPanel className="w-full max-w-sm p-6" variant="dirt">
                                <h2 className="font-silkscreen text-gold text-2xl mb-6 text-center">
                                    ‚öôÔ∏è ÈÅ∏ÂñÆ
                                </h2>
                                <div className="space-y-3">
                                    <PixelButton
                                        variant="danger"
                                        className="w-full"
                                        onClick={() => {
                                            setShowMenu(false);
                                            setShowResetConfirm(true);
                                        }}
                                    >
                                        üîÑ ÈáçÊñ∞ÈñãÂßã
                                    </PixelButton>
                                    <PixelButton
                                        variant="secondary"
                                        className="w-full"
                                        onClick={() => setShowMenu(false)}
                                    >
                                        ‚úï ÂèñÊ∂à
                                    </PixelButton>
                                </div>
                                <div className="mt-4 pt-3 border-t border-stoneDark/30 text-center">
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="text-[10px] font-silkscreen text-white/50 uppercase tracking-widest">
                                            Bubble Tea Tycoon v1.1.1
                                        </div>
                                        <span className="text-xs font-pixel text-gold/60 flex items-center gap-1 cursor-default">
                                            üíñ Ë´ãÊàëÂñùÊùØÊâãÊêñÈ£≤ üçµ
                                        </span>
                                    </div>
                                </div>
                            </PixelPanel>
                        </div>
                    )}

                    {showResetConfirm && (
                        <DialogModal
                            title="ÈáçÊñ∞ÈñãÂßã"
                            message="Á¢∫ÂÆöË¶ÅÂà™Èô§Â≠òÊ™î‰∏¶ÈáçÊñ∞ÈñãÂßãÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ"
                            confirmText="ÈáçÁΩÆ"
                            variant="danger"
                            onCancel={() => setShowResetConfirm(false)}
                            onConfirm={() => {
                                localStorage.removeItem('bobaKingState');
                                setGameState(INITIAL_STATE);
                                setShowResetConfirm(false);
                            }}
                        />
                    )}
                </div>
            );
        };

        // Mount the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('üßã Service Worker registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>

</html>